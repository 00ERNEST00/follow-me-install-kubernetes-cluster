# 本地 kube-apiserver 的 haproxy 代理

## 创建 kubelet 静态 static pod 定义文件

``` bash
cat > haproxy-static-pod.yaml <<EOF
apiVersion: v1
data:
  haproxy.cfg: |-
    global
        stats socket /var/run/haproxy-admin.sock mode 660 level admin
        stats timeout 30s
        user root
        group root
        nbproc 1

    defaults
        log     global
        timeout connect 5000
        timeout client  10m
        timeout server  10m

    listen  admin_stats
        bind 0.0.0.0:10080
        mode http
        log 127.0.0.1 local0 err
        stats refresh 30s
        stats uri /status
        stats realm welcome login Haproxy
        stats auth admin:123456
        stats hide-version
        stats admin if TRUE

    listen kube-master
        bind 0.0.0.0:8443
        mode tcp
        option tcplog
        balance source
        server 172.27.128.25 172.27.128.25:6443 check inter 2000 fall 2 rise 2 weight 1
        server 172.27.128.75 172.27.128.75:6443 check inter 2000 fall 2 rise 2 weight 1
        server 172.27.128.76 172.27.128.76:6443 check inter 2000 fall 2 rise 2 weight 1
        #haproxy-kube-apiservers
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: kube-system
---
apiVersion: v1
kind: Pod
metadata:
  name: haproxy
  namespace: kube-system
  labels:
    k8s-app: haproxy
spec:
  hostNetwork: true
  securityContext:
    runAsUser: 0
  containers:
    - name: haproxy
      image: haproxy:1.5.19
      command:
      - haproxy
      - -f
      - /etc/haproxy/haproxy.cfg
      ports:
        - name: status
          containerPort: 10080
        - name: apiserver
          containerPort: 8443
      volumeMounts:
      - name: haproxy-config
        mountPath: /etc/haproxy/
        readOnly: true
  volumes:
  - name: haproxy-config
    configMap:
      name: haproxy-config
EOF
```

## 将静态 Pod 定义文件下发到各节点
