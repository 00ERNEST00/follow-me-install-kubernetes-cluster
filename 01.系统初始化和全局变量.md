<!-- toc -->

tags: environment

# 01.系统初始化和全局变量

## 集群机器

+ m7-devops-128071：172.27.128.71 # m7-qa-ptest03
+ m7-devops-128107：172.27.128.107 # m7-cube-k8s03
+ m7-devops-128123：172.27.128.123 # m7-qa-test02

本文档中的 etcd 集群、master 节点、worker 节点均使用这三台机器。

## 更新主机系统

``` bash
sudo yum update -y
```

## 主机名

设置永久主机名称，然后重新登录:

``` bash
hostnamectl set-hostname m7-devops-128071 # 将 m7-devops-128071 替换为当前主机名称
```
+ 设置的主机名保存在 `/etc/hostname` 文件中；

修改每台机器的 `/etc/hosts` 文件，添加主机名和 IP 的对应关系：

``` bash
$ grep kube-node /etc/hosts
172.27.128.71 m7-devops-128071	m7-devops-128071
172.27.128.107 m7-devops-128107	m7-devops-128107
172.27.128.123 m7-devops-128123	m7-devops-128123
```

## 添加 k8s 和 docker 账户

在每台机器上添加 k8s 账户，可以无密码 sudo：

``` bash
sudo useradd -m k8s
echo 'passwd4k8s' | sudo passwd k8s --stdin # 设置 k8s 账户密码
sudo visudo # 删除 %wheel	ALL=(ALL)	NOPASSWD: ALL 一行前面的注释 #
sudo gpasswd -a k8s wheel
```

在每台机器上添加 docker 账户，将 k8s 账户添加到 docker 组中：

``` bash
sudo useradd -m docker
sudo gpasswd -a k8s docker
```

## 无密码 ssh 登录其它节点

如果没有特殊指明，本文档的所有操作**均在 m7-devops-128071 节点上执行**，然后远程分发文件和执行命令。

设置 m7-devops-128071 可以无密码登录**所有节点**的 root 账户：

``` bash
[root@m7-devops-128071 k8s]# ssh-keygen -t rsa
[root@m7-devops-128071 k8s]# ssh-copy-id root@m7-devops-128071
[root@m7-devops-128071 k8s]# ssh-copy-id root@m7-devops-128107
[root@m7-devops-128071 k8s]# ssh-copy-id root@m7-devops-128123
```

## 将可执行文件路径 /opt/k8s/bin 添加到 PATH 变量中

在每台机器上添加环境变量：

``` bash
echo 'PATH=/home/k8s/bin:/opt/k8s/bin:$PATH:$HOME/bin:$JAVA_HOME/bin' >>/root/.bashrc
echo 'PATH=/home/k8s/bin:/opt/k8s/bin:$PATH:$HOME/bin:$JAVA_HOME/bin' >>/home/k8s/.bashrc
chown k8s /home/k8s/.bashrc
```

## 安装依赖包

在每台机器上安装依赖包：

CentOS:

``` bash
sudo yum install -y epel-release
sudo yum install -y conntrack ipset sysstat curl iptables libseccomp
```

Ubuntu:

``` bash
sudo apt-get install -y conntrack ipset sysstat curl iptables libseccomp
```
+ ipvs 依赖 ipset；

## 关闭防火墙

在每台机器上关闭防火墙，清理防火墙规则，设置默认转发策略：

``` bash
sudo systemctl stop firewalld
sudo systemctl disable firewalld
sudo iptables -F && sudo iptables -X && sudo iptables -F -t nat && sudo iptables -X -t nat
sudo sudo iptables -P FORWARD ACCEPT
```

## 关闭 swap 分区

如果开启了 swap 分区，kubelet 会启动失败(可以通过将参数 --fail-swap-on 设置为 false 来忽略 swap on)，故需要在每台机器上关闭 swap 分区：

``` bash
sudo swapoff -a
```

为了防止开机自动挂载 swap 分区，可以注释 `/etc/fstab` 中相应的条目：

``` bash
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

## 关闭 SELinux

关闭 SELinux，否则后续 K8S 挂载目录时可能报错 `Permission denied`：

``` bash
sudo setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config  # 修改配置文件，永久生效
```

## 关闭 dnsmasq

linux 系统开启了 dnsmasq 后(如 GUI 环境)，将系统 DNS Server 设置为 127.0.0.1，这会导致 docker 容器无法解析域名，需要关闭它：

``` bash
sudo service dnsmasq stop
sudo systemctl disable dnsmasq
```

## 加载内核模块

``` bash
sudo modprobe br_netfilter
```

## 设置系统参数

``` bash
cat > kubernetes.conf <<EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
vm.swappiness=0
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
EOF
sudo cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf
sudo sysctl -p /etc/sysctl.d/kubernetes.conf
```
+ 关闭 IPV6，防止触发 docker BUG；


## 设置系统时区

``` bash
# 调整系统 TimeZone
sudo timedatectl set-timezone Asia/Shanghai

# 将当前的 UTC 时间写入硬件时钟
sudo timedatectl set-local-rtc 0

# 重启依赖于系统时间的服务
sudo systemctl restart rsyslog 
sudo systemctl restart crond
```

## 创建目录

在每台机器上创建目录：

``` bash
sudo mkdir -p  /home/k8s/bin /opt/k8s/bin /etc/kubernetes/cert /etc/etcd/cert /var/lib/etcd
sudo chown k8s /home/k8s/bin
```

## 升级内核

``` bash
sudo rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
# 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 memuentry 中是否包含 initrd16 配置，如果没有，再安装一次！
sudo yum --enablerepo=elrepo-kernel install -y kernel-lt
# 设置开机从新内核启动
grub2-set-default 0
```

安装内核源文件（可选）:
``` bash
# sudo yum --enablerepo=elrepo-kernel install kernel-lt-devel-4.4.143-1.el7.elrepo.x86_64
```

## 关闭 NUMA

``` bash
sudo cp /etc/default/grub{,.bak}
sudo vim /etc/default/grub # 在 GRUB_CMDLINE_LINUX 一行添加 `numa=off` 参数，如下所示：
sudo diff /etc/default/grub.bak /etc/default/grub
6c6
< GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos/root rhgb quiet"
---
> GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos/root rhgb quiet numa=off"
```

重新生成 grub2 配置文件：

``` bash
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

## 检查系统内核和模块是否适合运行 docker (仅适用于 linux 系统)

``` bash
curl https://raw.githubusercontent.com/docker/docker/master/contrib/check-config.sh > check-config.sh
bash ./check-config.sh
```

## 集群环境变量

后续的部署步骤将使用下面定义的全局环境变量，请根据**自己的机器、网络情况**修改：

``` bash
#!/usr/bin/bash

# TLS Bootstrapping 使用的 Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d ' ' 生成
BOOTSTRAP_TOKEN="41f7e4ba8b7be874fcff18bf5cf41a7c"

# 最好使用 当前未用的网段 来定义服务网段和 Pod 网段

# 服务网段，部署前路由不可达，部署后集群内路由可达(kube-proxy 保证)
SERVICE_CIDR="10.254.0.0/16"

# Pod 网段，建议 /16 段地址，部署前路由不可达，部署后集群内路由可达(flanneld 保证)
CLUSTER_CIDR="172.30.0.0/16"

# 服务端口范围 (NodePort Range)
export NODE_PORT_RANGE="30000-32767"

# 集群各机器 IP 数组
export NODE_IPS=(172.27.128.71 172.27.128.107 172.27.128.123)

# 集群各 IP 对应的 主机名数组
export NODE_NAMES=(m7-devops-128071 m7-devops-128107 m7-devops-128123)

# kube-apiserver 的 VIP（HA 组件 keepalived 发布的 IP）
export MASTER_VIP=172.27.128.254

# kube-apiserver VIP 地址（HA 组件 haproxy 监听 8443 端口）
export KUBE_APISERVER="https://${MASTER_VIP}:8443"

# HA 节点，配置 VIP 的网络接口名称
export VIP_IF="enp3s0f0"

# etcd 集群服务地址列表
export ETCD_ENDPOINTS="https://172.27.128.71:2379,https://172.27.128.107:2379,https://172.27.128.123:2379"

# etcd 集群间通信的 IP 和端口
export ETCD_NODES="m7-devops-128071=https://172.27.128.71:2380,m7-devops-128107=https://172.27.128.107:2380,m7-devops-128123=https://172.27.128.123:2380"

# flanneld 网络配置前缀
export FLANNEL_ETCD_PREFIX="/kubernetes/network"

# kubernetes 服务 IP (一般是 SERVICE_CIDR 中第一个IP)
export CLUSTER_KUBERNETES_SVC_IP="10.254.0.1"

# 集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)
export CLUSTER_DNS_SVC_IP="10.254.0.2"

# 集群 DNS 域名（末尾不带点号）
export CLUSTER_DNS_DOMAIN="cluster.local"

# 将二进制目录 /opt/k8s/bin 加到 PATH 中
export PATH=/opt/k8s/bin:$PATH
```
+ 打包后的变量定义见 [environment.sh](https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/manifests/environment.sh)，后续部署时会**提示导入**该脚本；

## 分发集群环境变量定义脚本

把全局变量定义脚本拷贝到**所有**节点的 `/opt/k8s/bin` 目录：

``` bash
source environment.sh
for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    scp environment.sh root@${node_ip}:/opt/k8s/bin/
    ssh root@${node_ip} "chmod +x /opt/k8s/bin/*"
  done
```

## 参考：
1. 系统内核相关参数参考：https://docs.openshift.com/enterprise/3.2/admin_guide/overcommit.html