<!-- toc -->

tags: master, kube-apiserver, kube-scheduler, kube-controller-manager

# 控制平面

kubernetes 控制平面包含如下组件：

+ etcd
+ kube-apiserver
+ kube-scheduler
+ kube-controller-manager

这 4 个组件均可以以集群模式运行，通过 leader 选举的方式产生一个工作进程，其它进程处于阻塞模式。

master 节点与 node 节点上的 Pods 通过 Pod 网络通信，所以需要在 master 节点上部署 Flannel 网络。

## 下载最新版本的二进制文件

从 [`CHANGELOG`页面](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md) 下载 `client` 或 `server` tarball 文件。`server` 的 tarball `kubernetes-server-linux-amd64.tar.gz` 已经包含了 `client`(`kubectl`) 二进制文件，所以不用单独下载`kubernetes-client-linux-amd64.tar.gz`文件。

``` bash
[k8s@kube-node1 k8s]$ cd /opt/k8s
[k8s@kube-node1 k8s]$ wget https://dl.k8s.io/v1.10.4/kubernetes-server-linux-amd64.tar.gz
[k8s@kube-node1 k8s]$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
[k8s@kube-node1 k8s]$ cd kubernetes
[k8s@kube-node1 k8s]$ tar -xzvf  kubernetes-src.tar.gz
```

将二进制文件拷贝到所有 master 节点机器：

``` bash
[k8s@kube-node1 k8s]$ for node_ip in ${NODE_IPS[@]}
  do
    scp kubernetes/server/bin/* k8s@${node_ip}:/opt/k8s/bin/
  done
```

## 安装和配置 flanneld

kube-apiserver 等可能需要访问 Pod 服务，所以控制命名的节点也需要和工作节点通过 Pod 网段互通，故也需要安装和配置 flanneld，参考 [05-部署Flannel网络.md](./05-部署Flannel网络.md)

## 其它说明

kube-controller-manager 和 kube-scheduler 是**被动**组件，它们不对外提供 API 服务。它们启动后，通过 kube-apiserver 来操作资源对象，所以需要有相关的权限。
+ Kubernetes 内置 ClusterRole system:kube-controller-manager 和 system:kube-scheduler，分别定义了 kube-controller-manager 和 kube-scheduler 工作所需要的权限。
+ Kubernetes 内置 ClusterRoleBindings system:kube-controller-manager 和 system:kube-scheduler，分别将用户 system:kube-controller-manager 和 system:kube-scheduler 与上面两个 ClusterRole 绑定，从而赋予它们相关权限。

kube-scheduler 启动后监听 http 10251 和 10252 端口，对外提供 prometheus metrics；
