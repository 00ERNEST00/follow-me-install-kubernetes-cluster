<!-- toc -->

tags: TLS, CA

# 创建 CA 证书和秘钥

`kubernetes` 系统各组件需要使用 `TLS` 证书对通信进行加密，本文档使用 `CloudFlare` 的 PKI 工具集 [cfssl](https://github.com/cloudflare/cfssl) 来生成 Certificate Authority (CA) 证书和秘钥文件。

CA 是自签名的根证书，用来签名后续创建的其它 TLS 证书。

## 安装 cfssl 工具集

``` bash
[k8s@kube-node1 ~]$ sudo mkdir -p /opt/k8s/ssl && sudo chown -R k8s /opt/k8s && cd /opt/k8s
[k8s@kube-node1 k8s]$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
[k8s@kube-node1 k8s]$ mv cfssl_linux-amd64 /opt/k8s/bin/cfssl

[k8s@kube-node1 k8s]$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
[k8s@kube-node1 k8s]$ mv cfssljson_linux-amd64 /opt/k8s/bin/cfssljson

[k8s@kube-node1 k8s]$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
[k8s@kube-node1 k8s]$ mv cfssl-certinfo_linux-amd64 /opt/k8s/bin/cfssl-certinfo

[k8s@kube-node1 k8s]$ chmod +x /opt/k8s/bin/*
[k8s@kube-node1 k8s]$ export PATH=/opt/k8s/bin:$PATH
[k8s@kube-node1 k8s]$
```

## 创建根证书 (CA，Certificate Authority)

CA 证书、私钥文件是集群所有机器共享的，本步骤**只需要执行一次**，然后将生成的文件分发到其它机器。

### 创建 CA 配置文件

CA 配置文件（ca-config.json）用于配置该 CA 证书的使用场景 (profiles) 和具体参数 (usage，如过期时间、服务端认证、客户端认证、加密等)，后续在前面其它证书时需要指定配置的某个场景。

``` bash
[k8s@kube-node1 ~]$ sudo mkdir -p /opt/k8s/ssl && sudo chown -R k8s /opt/k8s && cd /opt/k8s/ssl
[k8s@kube-node1 ssl]$ cat > ca-config.json <<EOF
{
  "signing": {
    "default": {
      "expiry": "8760h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "8760h"
      }
    }
  }
}
EOF
```
+ `signing`：表示该证书可用于签名其它证书，生成的 ca.pem 证书中 `CA=TRUE`；
+ `server auth`：表示 client 可以用该该证书对 server 提供的证书进行验证；
+ `client auth`：表示 server 可以用该该证书对 client 提供的证书进行验证；

### 创建 CA 证书签名请求

``` bash
[k8s@kube-node1 ssl]$ cat > /opt/k8s/ssl/ca-csr.json <<EOF
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "4Paradigm"
    }
  ]
}
EOF
```
+ "CN"：`Common Name`，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)，浏览器使用该字段验证网站是否合法；
+ "O"：`Organization`，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；

### 生成 CA 证书和私钥

``` bash
[k8s@kube-node1 ssl]$ cd /opt/k8s/ssl/
[k8s@kube-node1 ssl]$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
[k8s@kube-node1 ssl]$ ls ca*
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
$
```

## 分发 CA 证书文件

将生成的 CA 证书、秘钥文件、配置文件拷贝到**所有机器**的 `/etc/kubernetes/ssl` 目录下：

``` bash
[k8s@kube-node1 ssl]$ source /opt/k8s/bin/environment.sh # 导入 NODE_IPS 环境变量
[k8s@kube-node1 ssl]$ for node_ip in ${NODE_IPS[@]}
  do
    scp ca*.pem ca-config.json k8s@kube-node2:/etc/kubernetes/ssl
  done
```
+ k8s 账户需要有读写 /etc/kubernetes 目录及其子目录文件的权限；